---
# --- GitHub CLI repo ---

- name: Add GitHub CLI GPG key
  become: true
  ansible.builtin.shell:
    cmd: curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg -o /etc/apt/keyrings/githubcli-archive-keyring.gpg
    creates: /etc/apt/keyrings/githubcli-archive-keyring.gpg

- name: Add GitHub CLI APT repository
  become: true
  ansible.builtin.copy:
    content: "deb [arch=amd64 signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main\n"
    dest: /etc/apt/sources.list.d/github-cli.list
    mode: "0644"

# --- VS Code (desktop only) ---
# The code .deb auto-manages its own apt source (vscode.sources).
# Remove any manually-created source file to avoid Signed-By conflicts.

- name: Remove manual VS Code apt source (managed by .deb)
  become: true
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/vscode.list
    state: absent
  when: is_desktop | bool

# --- Common packages (all machines) ---

- name: Install common packages
  become: true
  ansible.builtin.apt:
    name:
      - curl
      - docker.io
      - docker-buildx
      - fastfetch
      - gcc
      - gh
      - git
      - glow
      - lazygit
      - make
      - openssh-server
      - python3-pip
    state: present
    update_cache: true

- name: Add user to docker group
  become: true
  ansible.builtin.user:
    name: "{{ username }}"
    groups: docker
    append: true

# --- Desktop packages ---

- name: Remove VS Code snap
  become: true
  community.general.snap:
    name: code
    state: absent
  when: is_desktop | bool

- name: Install desktop packages
  become: true
  ansible.builtin.apt:
    name:
      - code
      - ddcutil
      - deskflow
      - fprintd
      - libpam-fprintd
    state: present
    update_cache: true
  when: is_desktop | bool

- name: Enable fprintd PAM authentication
  become: true
  ansible.builtin.command: pam-auth-update --enable fprintd
  changed_when: false
  when: is_desktop | bool
